name: Combined Release Build (Android + Windows)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  FLUTTER_VERSION: '3.24.0'
  NDK_VERSION: r26d
  CHANNEL: prod

jobs:
  build-android-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Resolve version and update pubspec
        id: versioning
        run: |
          # 优先使用手动触发时的版本输入，否则使用 tag 名
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RAW_VERSION="${{ github.event.inputs.version }}"
          else
            RAW_VERSION="${{ github.ref_name }}"
          fi
          # 去掉可能的前缀 v
          RAW_VERSION="${RAW_VERSION#v}"
          BUILD_NUMBER="${GITHUB_RUN_NUMBER:-1}"
          VERSION_STRING="${RAW_VERSION}+${BUILD_NUMBER}"

          echo "Resolved version: $VERSION_STRING"
          echo "APP_VERSION=$RAW_VERSION" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "VERSION_STRING=$VERSION_STRING" >> $GITHUB_ENV
          echo "app_version=$RAW_VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "version_string=$VERSION_STRING" >> $GITHUB_OUTPUT

          # 覆盖 pubspec.yaml 中的版本号，让应用显示为输入的版本
          perl -0pi -e 's/^version:\s*.*/version: '"$VERSION_STRING"'/m' pubspec.yaml
          grep -n "^version:" pubspec.yaml

      - name: Setup Flutter
        uses: subosito/flutter-action@v2.16.0
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 17

      - name: Setup NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.NDK_VERSION }}
          add-to-path: true
          link-to-sdk: true

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: 7.5

      - name: Setup dependencies
        run: |
          make android-apk-install-dependencies || echo "Dependencies setup completed"

      - name: Setup Keystore
        run: |
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "Setting up keystore from GitHub Secrets..."
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > moneyfly-release-key.jks
            cat > key.properties << EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=moneyfly-release-key.jks
          EOF
            chmod 600 moneyfly-release-key.jks
            chmod 644 key.properties
            echo "✓ Keystore configured successfully"
          else
            echo "⚠ No keystore configured. APK will be signed with debug key."
          fi

      - name: Prepare for Android APK
        run: |
          export CHANNEL=prod
          make android-apk-prepare
          echo "=== AAR 文件检查 ==="
          ls -lh android/app/libs/*.aar 2>/dev/null || echo "未找到 AAR 文件"

      - name: Verify AAR file
        run: |
          if [ -f android/app/libs/libcore.aar ]; then
            echo "✓ AAR file exists"
            ls -lh android/app/libs/libcore.aar
            TEMP_DIR=$(mktemp -d)
            unzip -q android/app/libs/libcore.aar -d "$TEMP_DIR" 2>/dev/null || true
            if [ -f "$TEMP_DIR/classes.jar" ]; then
              if jar tf "$TEMP_DIR/classes.jar" 2>/dev/null | grep -q "io/nekohasekai/libbox"; then
                echo "✓ AAR package name verified: io.nekohasekai"
              else
                echo "✗ AAR package name mismatch!"
                exit 1
              fi
            fi
            rm -rf "$TEMP_DIR"
          else
            echo "✗ AAR file not found!"
            exit 1
          fi

      - name: Build Android APK
        env:
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        run: |
          make android-apk-release
          ls -R build/app/outputs/flutter-apk/ || echo "APK output check"

      - name: Copy APK files
        run: |
          mkdir -p out
          cp build/app/outputs/flutter-apk/*arm64-v8a*.apk out/Moneyfly-Android-arm64.apk 2>/dev/null || echo "no arm64 apk"
          cp build/app/outputs/flutter-apk/*armeabi-v7a*.apk out/Moneyfly-Android-arm7.apk 2>/dev/null || echo "no arm7 apk"
          cp build/app/outputs/flutter-apk/*x86_64*.apk out/Moneyfly-Android-x86_64.apk 2>/dev/null || echo "no x64 apk"
          cp build/app/outputs/flutter-apk/app-release.apk out/Moneyfly-Android-universal.apk 2>/dev/null || echo "no universal apk"
          ls -lh out/

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: out/*.apk
          retention-days: 30

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Resolve version and update pubspec
        id: versioning
        run: |
          # 优先使用手动触发时的版本输入，否则使用 tag 名
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $rawVersion = "${{ github.event.inputs.version }}"
          } else {
            $rawVersion = "${{ github.ref_name }}"
          }
          # 去掉可能的前缀 v
          $rawVersion = $rawVersion -replace '^v', ''
          $buildNumber = "${{ github.run_number }}"
          if ([string]::IsNullOrEmpty($buildNumber)) {
            $buildNumber = "1"
          }
          $versionString = "$rawVersion+$buildNumber"

          Write-Host "Resolved version: $versionString"
          Write-Host "APP_VERSION=$rawVersion" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "BUILD_NUMBER=$buildNumber" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "VERSION_STRING=$versionString" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "app_version=$rawVersion" >> $env:GITHUB_OUTPUT
          Write-Host "build_number=$buildNumber" >> $env:GITHUB_OUTPUT
          Write-Host "version_string=$versionString" >> $env:GITHUB_OUTPUT

          # 覆盖 pubspec.yaml 中的版本号，让应用显示为输入的版本
          $pubspecContent = Get-Content -Path "pubspec.yaml" -Raw -Encoding utf8
          $pubspecContent = $pubspecContent -replace '(?m)^version:\s*.*', "version: $versionString"
          Set-Content -Path "pubspec.yaml" -Value $pubspecContent -Encoding utf8 -NoNewline
          Write-Host "Updated pubspec.yaml version to: $versionString"
          Select-String -Path "pubspec.yaml" -Pattern "^version:"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2.16.0
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup dependencies
        run: |
          Write-Host "Checking Visual Studio build tools..."
          if (-not (Get-Command cmake -ErrorAction SilentlyContinue)) {
            Write-Host "⚠ CMake not found, but continuing..."
          }
          
          dart pub global activate flutter_distributor
          $env:PATH = "$env:PATH;$env:USERPROFILE\.pub-cache\bin"
          
          Write-Host "Getting Flutter dependencies..."
          flutter pub get
          Write-Host "Upgrading Flutter dependencies..."
          flutter pub upgrade

      - name: Prepare for Windows build
        env:
          CHANNEL: prod
          IS_GITHUB_ACTIONS: 1
        run: |
          flutter config --enable-windows-desktop
          flutter doctor -v
          if (Get-Command make -ErrorAction SilentlyContinue) {
            bash -c "make windows-prepare"
          } else {
            Write-Host "Make not available, using direct commands..."
            flutter pub get
            dart run build_runner build --delete-conflicting-outputs
            dart run slang
            $coreVersion = (Get-Content dependencies.properties | Select-String 'core.version=(\S+)' | ForEach-Object { $_.Matches.Groups[1].Value })
            $coreUrl = "https://github.com/hiddify/hiddify-next-core/releases/download/v$coreVersion/hiddify-core-windows-amd64.tar.gz"
            New-Item -ItemType Directory -Force -Path "libcore\bin" | Out-Null
            Invoke-WebRequest -Uri $coreUrl -OutFile "libcore-bin.tar.gz"
            tar -xzf libcore-bin.tar.gz -C libcore\bin
            Remove-Item libcore-bin.tar.gz
          }

      - name: Build Windows
        env:
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          CHANNEL: prod
          IS_GITHUB_ACTIONS: 1
        run: |
          $env:PATH = "$env:PATH;$env:USERPROFILE\.pub-cache\bin"
          
          Write-Host "=== Starting Windows Build ==="
          flutter config --enable-windows-desktop
          
          Write-Host "Building with Flutter directly..."
          flutter build windows --target lib/main_prod.dart --dart-define sentry_dsn=$env:SENTRY_DSN --release
          
          if (-not (Test-Path "build\windows\x64\runner\Release")) {
            Write-Error "Flutter build failed: build directory not found"
            exit 1
          }
          
          Write-Host "✓ Flutter build completed successfully"
          
          # 复制 libcore 文件到构建输出目录
          if (Test-Path "libcore\bin") {
            $libcoreFiles = Get-ChildItem -Path "libcore\bin" -File
            if ($libcoreFiles) {
              $releaseDir = "build\windows\x64\runner\Release"
              foreach ($file in $libcoreFiles) {
                Copy-Item $file.FullName -Destination $releaseDir -Force
              }
            }
          }
          
          # 使用 flutter_distributor 打包
          dart pub global activate flutter_distributor
          $env:PATH = "$env:PATH;$env:USERPROFILE\.pub-cache\bin"
          
          Write-Host "=== Packaging with flutter_distributor ==="
          flutter_distributor package --flutter-build-args=verbose --platform windows --targets exe,msix --skip-clean --build-target lib/main_prod.dart --build-dart-define sentry_dsn=$env:SENTRY_DSN
          
          Write-Host "✓ Build completed successfully"

      - name: Copy Windows files
        run: |
          New-Item -ItemType Directory -Force -Path "out" | Out-Null
          $version = "${{ github.event.inputs.version }}"
          if ($version -eq "") {
            $version = "${{ github.ref_name }}"
          }
          $version = $version -replace '^v', ''
          
          $filesCopied = $false
          
          # 查找 dist 目录中的文件
          if (Test-Path "dist") {
            $distFiles = Get-ChildItem -Path "dist" -Recurse -File
            if ($distFiles) {
              # 查找安装程序 EXE
              $setupExeFiles = Get-ChildItem -Path "dist" -Recurse -Filter "*setup*.exe"
              if (-not $setupExeFiles) {
                $setupExeFiles = Get-ChildItem -Path "dist" -Recurse -Filter "*windows*.exe"
              }
              if (-not $setupExeFiles) {
                $allExeFiles = Get-ChildItem -Path "dist" -Recurse -Filter "*.exe"
                $setupExeFiles = $allExeFiles | Where-Object { 
                  $_.Name -notmatch "temp|tmp|test" -and $_.Length -gt 1MB 
                }
              }
              if ($setupExeFiles) {
                $setupExeFiles | ForEach-Object {
                  Copy-Item $_.FullName -Destination "out\Moneyfly-Windows-Setup-x64-$version.exe" -Force
                  $filesCopied = $true
                }
              }
              
              # 查找 MSIX
              $msixFiles = Get-ChildItem -Path "dist" -Recurse -Filter "*.msix"
              if ($msixFiles) {
                $msixFiles | ForEach-Object {
                  Copy-Item $_.FullName -Destination "out\Moneyfly-Windows-x64-$version.msix" -Force
                  $filesCopied = $true
                }
              }
            }
          }
          
          # 从 build 目录创建便携版 ZIP
          if (Test-Path "build\windows\x64\runner\Release") {
            if (Test-Path "libcore\bin") {
              $libcoreFiles = Get-ChildItem -Path "libcore\bin" -File
              foreach ($file in $libcoreFiles) {
                $destPath = "build\windows\x64\runner\Release\$($file.Name)"
                if (-not (Test-Path $destPath)) {
                  Copy-Item $file.FullName -Destination $destPath -Force
                }
              }
            }
            
            $zipPath = "out\Moneyfly-Windows-Portable-x64-$version.zip"
            if (Test-Path $zipPath) {
              Remove-Item $zipPath -Force
            }
            
            Compress-Archive -Path "build\windows\x64\runner\Release\*" -DestinationPath $zipPath -Force -CompressionLevel Optimal
            $filesCopied = $true
          }
          
          if (-not $filesCopied) {
            Write-Error "No files to copy! Build may have failed."
            exit 1
          }
          
          Write-Host "=== Final output files ==="
          Get-ChildItem -Path "out" | Select-Object Name, Length

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: out/*
          retention-days: 30

  release:
    name: Create Combined Release
    needs: [build-android-apk, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: ./out/android

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: ./out/windows

      - name: Get version tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Prepare release files
        run: |
          mkdir -p ./out/release
          # 复制 Android APK 文件
          if [ -d "./out/android" ]; then
            cp ./out/android/*.apk ./out/release/ 2>/dev/null || true
          fi
          # 复制 Windows 文件
          if [ -d "./out/windows" ]; then
            cp ./out/windows/* ./out/release/ 2>/dev/null || true
          fi
          echo "=== Release files ==="
          ls -lh ./out/release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: ${{ steps.get_version.outputs.version }}
          body: |
            ## Combined Release ${{ steps.get_version.outputs.version }}
            
            ### Android Downloads
            - **Universal APK**: [Moneyfly-Android-universal.apk](./Moneyfly-Android-universal.apk)
            - **ARM64 APK**: [Moneyfly-Android-arm64.apk](./Moneyfly-Android-arm64.apk)
            - **ARMv7 APK**: [Moneyfly-Android-arm7.apk](./Moneyfly-Android-arm7.apk)
            - **x86_64 APK**: [Moneyfly-Android-x86_64.apk](./Moneyfly-Android-x86_64.apk)
            
            ### Windows Downloads
            - **Windows Setup (Installer)**: [Moneyfly-Windows-Setup-x64-${{ steps.get_version.outputs.version }}.exe](./Moneyfly-Windows-Setup-x64-${{ steps.get_version.outputs.version }}.exe)
              - Double-click to install
              - Creates desktop shortcut
              - Installs to Program Files
            - **Windows Portable**: [Moneyfly-Windows-Portable-x64-${{ steps.get_version.outputs.version }}.zip](./Moneyfly-Windows-Portable-x64-${{ steps.get_version.outputs.version }}.zip)
              - Extract and run directly
              - No installation required
            - **Windows MSIX**: [Moneyfly-Windows-x64-${{ steps.get_version.outputs.version }}.msix](./Moneyfly-Windows-x64-${{ steps.get_version.outputs.version }}.msix)
              - Microsoft Store format
            
            ### Installation Instructions
            
            **Android:**
            1. Download the APK file for your device architecture
            2. Enable "Install from unknown sources" in Android settings
            3. Tap the downloaded APK to install
            
            **Windows:**
            - **Using Setup (Recommended):** Download the `.exe` installer and run it
            - **Using Portable:** Download the ZIP file, extract it, and run `Moneyfly.exe`
          files: ./out/release/*
          draft: false
          prerelease: false

